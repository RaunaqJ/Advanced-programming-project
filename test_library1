"""
Test Suite for Online Library Application
Tests for backend API and frontend integration
"""

import unittest
import json
import os
import sys
from backend import app, load_media, save_media


class TestBackend(unittest.TestCase):
    """Test cases for backend functionality"""
    
    @classmethod
    def setUpClass(cls):
        """Set up test environment before all tests"""
        cls.test_file = 'test_media.json'
        cls.original_file = 'media.json'
        
    def setUp(self):
        """Set up before each test"""
        # Configure Flask for testing
        app.config['TESTING'] = True
        self.client = app.test_client()
        
        # Backup original data file if it exists
        if os.path.exists(self.original_file):
            os.rename(self.original_file, f"{self.original_file}.backup")
        
        # Create test data
        self.test_data = [
            {
                'id': 1,
                'name': 'Inception',
                'publication_date': '2010',
                'author': 'Christopher Nolan',
                'category': 'Film'
            },
            {
                'id': 2,
                'name': 'The Dark Knight',
                'publication_date': '2008',
                'author': 'Christopher Nolan',
                'category': 'Film'
            },
            {
                'id': 3,
                'name': 'Clean Code',
                'publication_date': '2008',
                'author': 'Robert C. Martin',
                'category': 'Book'
            }
        ]
        
        # Save test data to file
        with open('media.json', 'w', encoding='utf-8') as f:
            json.dump(self.test_data, f)
    
    def tearDown(self):
        """Clean up after each test"""
        # Remove test data file
        if os.path.exists('media.json'):
            os.remove('media.json')
        
        # Restore original data file
        if os.path.exists(f"{self.original_file}.backup"):
            os.rename(f"{self.original_file}.backup", self.original_file)
    
    def test_get_all_media(self):
        """Test endpoint 1: Get all media items"""
        response = self.client.get('/api/media')
        self.assertEqual(response.status_code, 200)
        
        data = json.loads(response.data)
        self.assertTrue(data['success'])
        self.assertEqual(data['count'], 3)
        self.assertEqual(len(data['data']), 3)
        print("PASS: Get all media endpoint works correctly")
    
    def test_get_media_by_category(self):
        """Test endpoint 2: Get media by category"""
        # Test Film category
        response = self.client.get('/api/media/category/Film')
        self.assertEqual(response.status_code, 200)
        
        data = json.loads(response.data)
        self.assertTrue(data['success'])
        self.assertEqual(data['count'], 2)
        
        # Verify all returned items are films
        for item in data['data']:
            self.assertEqual(item['category'], 'Film')
        
        # Test Book category
        response = self.client.get('/api/media/category/Book')
        data = json.loads(response.data)
        self.assertEqual(data['count'], 1)
        print("PASS: Get media by category works correctly")
    
    def test_search_media_exact_match(self):
        """Test endpoint 3: Search for media by exact name"""
        # Test existing media
        response = self.client.get('/api/media/search?name=Inception')
        self.assertEqual(response.status_code, 200)
        
        data = json.loads(response.data)
        self.assertTrue(data['success'])
        self.assertEqual(data['count'], 1)
        self.assertEqual(data['data'][0]['name'], 'Inception')
        
        # Test non-existing media
        response = self.client.get('/api/media/search?name=NonExistentMovie')
        data = json.loads(response.data)
        self.assertEqual(data['count'], 0)
        
        # Test case insensitivity
        response = self.client.get('/api/media/search?name=inception')
        data = json.loads(response.data)
        self.assertEqual(data['count'], 1)
        print("PASS: Search media by name works correctly")
    
    def test_get_media_details(self):
        """Test endpoint 4: Get specific media details"""
        # Test existing media
        response = self.client.get('/api/media/1')
        self.assertEqual(response.status_code, 200)
        
        data = json.loads(response.data)
        self.assertTrue(data['success'])
        self.assertEqual(data['data']['id'], 1)
        self.assertEqual(data['data']['name'], 'Inception')
        
        # Test non-existing media
        response = self.client.get('/api/media/999')
        self.assertEqual(response.status_code, 404)
        
        data = json.loads(response.data)
        self.assertFalse(data['success'])
        print("PASS: Get media details works correctly")
    
    def test_create_media(self):
        """Test endpoint 5: Create new media item"""
        new_media = {
            'name': 'Interstellar',
            'publication_date': '2014',
            'author': 'Christopher Nolan',
            'category': 'Film'
        }
        
        response = self.client.post(
            '/api/media',
            data=json.dumps(new_media),
            content_type='application/json'
        )
        self.assertEqual(response.status_code, 201)
        
        data = json.loads(response.data)
        self.assertTrue(data['success'])
        self.assertEqual(data['data']['name'], 'Interstellar')
        self.assertIn('id', data['data'])
        
        # Verify media was saved
        response = self.client.get('/api/media')
        data = json.loads(response.data)
        self.assertEqual(data['count'], 4)
        print("PASS: Create new media works correctly")
    
    def test_create_media_validation(self):
        """Test media creation with invalid data"""
        # Test missing required field
        invalid_media = {
            'name': 'Test Movie',
            'author': 'Test Director'
            # Missing publication_date and category
        }
        
        response = self.client.post(
            '/api/media',
            data=json.dumps(invalid_media),
            content_type='application/json'
        )
        self.assertEqual(response.status_code, 400)
        
        data = json.loads(response.data)
        self.assertFalse(data['success'])
        
        # Test invalid category
        invalid_category = {
            'name': 'Test Movie',
            'publication_date': '2020',
            'author': 'Test Director',
            'category': 'InvalidCategory'
        }
        
        response = self.client.post(
            '/api/media',
            data=json.dumps(invalid_category),
            content_type='application/json'
        )
        self.assertEqual(response.status_code, 400)
        print("PASS: Input validation works correctly")
    
    def test_delete_media(self):
        """Test endpoint 6: Delete media item"""
        # Test deleting existing media
        response = self.client.delete('/api/media/1')
        self.assertEqual(response.status_code, 200)
        
        data = json.loads(response.data)
        self.assertTrue(data['success'])
        self.assertEqual(data['deleted_media']['id'], 1)
        
        # Verify media was deleted
        response = self.client.get('/api/media')
        data = json.loads(response.data)
        self.assertEqual(data['count'], 2)
        
        # Test deleting non-existing media
        response = self.client.delete('/api/media/999')
        self.assertEqual(response.status_code, 404)
        
        data = json.loads(response.data)
        self.assertFalse(data['success'])
        print("PASS: Delete media works correctly")
    
    def test_data_persistence(self):
        """Test that data is properly saved and loaded"""
        # Load current data
        media_list = load_media()
        original_count = len(media_list)
        
        # Add new item
        new_item = {
            'id': 99,
            'name': 'Test Persistence',
            'publication_date': '2024',
            'author': 'Test Author',
            'category': 'Film'
        }
        media_list.append(new_item)
        
        # Save data
        result = save_media(media_list)
        self.assertTrue(result)
        
        # Load data again and verify
        reloaded_data = load_media()
        self.assertEqual(len(reloaded_data), original_count + 1)
        self.assertIn(new_item, reloaded_data)
        print("PASS: Data persistence works correctly")
    
    def test_empty_search_parameter(self):
        """Test search with empty parameter"""
        response = self.client.get('/api/media/search?name=')
        self.assertEqual(response.status_code, 400)
        
        data = json.loads(response.data)
        self.assertFalse(data['success'])
        print("PASS: Empty search parameter handled correctly")
    
    def test_category_case_insensitive(self):
        """Test category filtering is case insensitive"""
        response = self.client.get('/api/media/category/film')
        self.assertEqual(response.status_code, 200)
        
        data = json.loads(response.data)
        self.assertTrue(data['success'])
        self.assertEqual(data['count'], 2)
        print("PASS: Case-insensitive category filtering works")


class TestFrontendIntegration(unittest.TestCase):
    """Test cases for frontend integration with backend"""
    
    @classmethod
    def setUpClass(cls):
        """Set up test environment"""
        app.config['TESTING'] = True
        cls.client = app.test_client()
    
    def setUp(self):
        """Set up test data before each test"""
        self.test_data = [
            {
                'id': 1,
                'name': 'Test Film 1',
                'publication_date': '2020',
                'author': 'Director 1',
                'category': 'Film'
            },
            {
                'id': 2,
                'name': 'Test Film 2',
                'publication_date': '2021',
                'author': 'Director 2',
                'category': 'Film'
            }
        ]
        
        # Backup original file
        if os.path.exists('media.json'):
            os.rename('media.json', 'media.json.backup')
        
        # Create test file
        with open('media.json', 'w', encoding='utf-8') as f:
            json.dump(self.test_data, f)
    
    def tearDown(self):
        """Clean up after each test"""
        if os.path.exists('media.json'):
            os.remove('media.json')
        if os.path.exists('media.json.backup'):
            os.rename('media.json.backup', 'media.json')
    
    def test_frontend_can_load_all_media(self):
        """Test that frontend can successfully load all media"""
        response = self.client.get('/api/media')
        self.assertEqual(response.status_code, 200)
        
        data = json.loads(response.data)
        self.assertTrue(data['success'])
        self.assertIsInstance(data['data'], list)
        self.assertEqual(len(data['data']), 2)
        print("PASS: Frontend can load all media")
    
    def test_frontend_can_filter_by_category(self):
        """Test category filtering functionality"""
        response = self.client.get('/api/media/category/Film')
        self.assertEqual(response.status_code, 200)
        
        data = json.loads(response.data)
        self.assertTrue(data['success'])
        self.assertEqual(data['count'], 2)
        print("PASS: Frontend can filter by category")
    
    def test_frontend_can_search(self):
        """Test search functionality"""
        response = self.client.get('/api/media/search?name=Test Film 1')
        self.assertEqual(response.status_code, 200)
        
        data = json.loads(response.data)
        self.assertTrue(data['success'])
        self.assertEqual(data['count'], 1)
        print("PASS: Frontend search functionality works")
    
    def test_frontend_can_create_media(self):
        """Test creating media through API"""
        new_media = {
            'name': 'Frontend Test Film',
            'publication_date': '2023',
            'author': 'Test Director',
            'category': 'Film'
        }
        
        response = self.client.post(
            '/api/media',
            data=json.dumps(new_media),
            content_type='application/json'
        )
        self.assertEqual(response.status_code, 201)
        
        data = json.loads(response.data)
        self.assertTrue(data['success'])
        print("PASS: Frontend can create media")
    
    def test_frontend_can_delete_media(self):
        """Test deleting media through API"""
        response = self.client.delete('/api/media/1')
        self.assertEqual(response.status_code, 200)
        
        data = json.loads(response.data)
        self.assertTrue(data['success'])
        
        # Verify deletion
        response = self.client.get('/api/media')
        data = json.loads(response.data)
        self.assertEqual(data['count'], 1)
        print("PASS: Frontend can delete media")


def run_tests():
    """Run all tests and display results"""
    print("=" * 70)
    print("Running Online Library Test Suite")
    print("=" * 70)
    print()
    
    # Create test suite
    loader = unittest.TestLoader()
    suite = unittest.TestSuite()
    
    # Add test cases
    suite.addTests(loader.loadTestsFromTestCase(TestBackend))
    suite.addTests(loader.loadTestsFromTestCase(TestFrontendIntegration))
    
    # Run tests with verbose output
    runner = unittest.TextTestRunner(verbosity=2)
    result = runner.run(suite)
    
    # Print summary
    print()
    print("=" * 70)
    print("Test Summary")
    print("=" * 70)
    print(f"Tests run: {result.testsRun}")
    print(f"Successes: {result.testsRun - len(result.failures) - len(result.errors)}")
    print(f"Failures: {len(result.failures)}")
    print(f"Errors: {len(result.errors)}")
    print("=" * 70)
    
    if result.wasSuccessful():
        print("All tests passed successfully!")
    else:
        print("Some tests failed. Please review the output above.")
    
    return result.wasSuccessful()


if __name__ == '__main__':
    success = run_tests()
    sys.exit(0 if success else 1)